#!/usr/bin/env ruby

require 'fileutils'

include FileUtils

def sh(cmd)
  puts %x{#{cmd}}
end

app_name = if ARGV.first
             ARGV.first.chomp
           else
             puts "What's your app's name? "
             app_name = STDIN.gets.chomp
           end

kick_it_dir = '/tmp/kick-it'
app_dir = File.join(kick_it_dir, app_name)
mkdir_p kick_it_dir
rm_rf app_dir

Dir.chdir(kick_it_dir) do
  sh "rails _3.2.15_ new #{app_name} --skip-active-record --skip-bundle"
end

open(File.join(app_dir, 'Gemfile'), 'a') do |f|
  f.puts %{
gem 'infopark_cloud_connector'
gem 'infopark_kickstarter'
  }
end

kick_it_config_dir = File.join(ENV['HOME'], '.config/kick-it')
mkdir_p kick_it_config_dir

rails_connector_config = File.join(kick_it_config_dir, 'rails_connector.yml')
custom_cloud_config = File.join(kick_it_config_dir, 'custom_cloud.yml')

begin
  cp rails_connector_config, File.join(app_dir, 'config/rails_connector.yml')
  cp custom_cloud_config, File.join(app_dir, 'config/custom_cloud.yml')
rescue
  puts "[Error] You have an empty #{kick_it_config_dir}"
  exit 1
end

open(File.join(app_dir, '.gitignore'), 'w') do |f|
  f.puts %{
config/rails_connector.yml
config/custom_cloud.yml
  }
end

Dir.chdir(app_dir) do
  sh 'bundle'
  sh 'rails g cms:kickstart --examples'
  sh 'bundle exec rake cms:reset[true]'
  sh 'bundle exec rake cms:migrate'
end

puts %{

  Now start the app:

    cd #{app_dir} && rails s -p3013

}
